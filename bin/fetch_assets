#!/usr/bin/env bash
set -Exeuo pipefail

SCRIPT_DIR=$( cd -- "$( dirname -- "${BASH_SOURCE[0]}" )" &> /dev/null && pwd )
LANDINGPAGE_DIR="$(dirname "$SCRIPT_DIR")"

cd "$LANDINGPAGE_DIR/assets"

download() {
    # Tries to only download if remote is more recent
    url="$1"
    file="$2"
    if [ -f "$file" ]; then
        curl -L -s -o "$file" -z "$file" "$url"
    else
        curl -L -s -o "$file" "$url"
    fi
}

git_download() {
    repo="$1"
    dir="$2"
    shift; shift; clone_args=("$@")
    if [ -d "$dir" ]; then
        git -C "$dir" pull
    else
        git clone "$repo" "${clone_args[@]}" "$dir"
    fi
}

# Development -> we use the JS magic thingy
download https://cdn.tailwindcss.com?plugins=forms js/tailwinds.js

# Dark theme stuff
# git_download https://github.com/jjranalli/nightwind

# Icons / Fontawesome
download https://use.fontawesome.com/releases/v7.2.0/fontawesome-free-7.2.0-web.zip fonts/fontawesome.zip
unzip fonts/fontawesome.zip -d fonts/
rm -rf fonts/fontawesome
mv fonts/fontawesome-*-web fonts/fontawesome

# Font
git_download https://github.com/adobe-fonts/source-sans fonts/source-sans --depth 1 --single-branch
sleep 0.5

# Production -> download standalone tailwind to compile only what we need
architecture="x64"
case $(uname -m) in
    aarch64) architecture="arm64" ;;
    armv7)   architecture="armv7" ;;
    x86_64)  architecture="x64" ;;
esac
download https://github.com/tailwindlabs/tailwindcss/releases/download/v3.4.17/tailwindcss-linux-${architecture} tailwindcss-linux
chmod u+x tailwindcss-linux

# JS deps
download https://cdn.jsdelivr.net/npm/chart.js@4.4.8/dist/chart.umd.min.js js/chart.js

# Here's how you generate the dist directory:
# cp -Rf assets dist/
# ./assets/tailwindcss-linux --input assets/css/input.css --output dist/assets/css/prod.min.css --content dist/index.en.html
